#set page=Save Load

<h4>What can I do with Save/Load addon?</h4>
<ul>
    <li>Save/load the state of the database to/from byte array during runtime on players devices</li>
    <li>Define which table and which fields you want to be saved/loaded using <a href="#mergesettings">merge settings</a> <span style="color: red">(it won't work if you skip this step)</span></li>
    <li>Create C# class for fine-grained row-level control.</li>
    <li>You can save the whole database without Save/Load addon (<a href="#saveAll">click</a>)</li>
</ul>

<h4>Should I use additional save/load solutions besides this addon?</h4>
It's perfectly fine to use BGDatabase as the only solution for saving/loading, but it's a safer option to use a professional Save/Load solution
and save database content as a part of all saved data (as a byte array field), even if you do not have any other data to save at the moment.

<h4 id="limitations">Restrictions</h4>
<p>Data inside partitions, created with <a href="../Partition">partitioning addon</a> can not be saved/loaded properly</p>

<h4>How can I enable it?</h4>
Choose <code>Addons->Save Load</code>, click "Enable", mark tables/fields for saving/loading and save the database.
<div class="bg-image">
    <a href="#path images/BGDatabase/SaveLoadAddon5.png"><img style="width: 400px" src="#path images/BGDatabase/SaveLoadAddon5.png"></a>
</div>

<h4>Examples</h4>
<p>
    The following projects use SaveLoad addon to save/load runtime data:
</p>
<ol>
    <li><a href="../../Downloads/Example3DBasic">Basic 3D example</a></li>
    <li><a href="../../Downloads/Example2DBasic">Basic 2D example</a></li>
    <li><a href="../../Downloads/ExampleInventory">Inventory example</a></li>
    <li><a href="../../Downloads/ExampleLocalization">Localization example</a> (localization addon is required)</li>
</ol>

<h4>How it works?</h4>
<p>
    SaveLoad addon can create multiple, configurable snapshots of database data and it can restore database state from these snapshots.
    Snapshots are constructed from the data, you marked as <i>changeable</i>, using <a href="#mergesettings">Merge settings</a>, described below. (<a href="#why">Why it works like this?</a>)
    Please, make sure you marked all data you want to be saved.
</p>
<div class="bg-image">
    <a href="#path images/BGDatabase/SaveLoadAddonReview.png"><img style="width: 400px" src="#path images/BGDatabase/SaveLoadAddonReview.png"></a>
</div>
<p>
    [Important] Loading with SaveLoad addon results in whole database to be reloaded,
    so if you use SaveLoad addon do not store references to tables/fields/entities, cause they will be obsolete after loading.
</p>

<h4 id="why">Why it works like this?</h4>
<p>
    Here is the quick explanation and main reasons why it works the way it works and why it's much better then simply saving the whole database.
</p>
<ol>
    <li>we want to be able to change database between public game releases</li>
    <li>we want to make sure the old saves, which are made with old version of database will remain compatible with new database</li>
    <li>As a result of loading old save, we want to keep all saved data and we want to keep the changes we made to default database (shipped with a game)</li>
</ol>
<p>
    Here is the detailed illustration about what we want to achieve:
</p>
<div class="bg-image">
    <a href="#path images/BGDatabase/SaveLoadAddon3.png"><img style="width: 400px"
                                                              src="#path images/BGDatabase/SaveLoadAddon3.png"></a>
</div>

<p>
    Another diagram:
</p>

<div class="bg-image">
    <a href="#path images/BGDatabase/SaveLoadAddon4.png"><img style="width: 400px"
                                                              src="#path images/BGDatabase/SaveLoadAddon4.png"></a>
</div>

<div class="flexdiv">
    <div>
        Read more about:
        <ol>
            <li>How to change your database and keep it compatible with old save files- read the <a href="#compatible">section below</a></li>
            <li>How to implement row-level control over merging- read <a href="#rowlevelexample">Row-level controller</a> section below.</li>
        </ol>
    </div>
</div>

<h4>How to use it?</h4>

<pre class="nomargin"><code class="language-csharp">
//to save
byte[] bytes = BGRepo.I.Addons.Get&lt;BGAddonSaveLoad&gt;().Save();

//to load
BGRepo.I.Addons.Get&lt;BGAddonSaveLoad&gt;().Load(bytes);
</code></pre>
<p>
    Once you obtained bytes array using Save method, you need to write it to some persistent storage (file or cloud drive)
    See <a href="../../Downloads/SaveLoadManager.txt">this minimalistic example</a> for more details.
    There are also custom units/actions for Visual Scripting tools are available (see the full list at the bottom of this page)
</p>

<h4 id="saveAll">Is it possible to save/load the whole database?</h4>
<pre class="nomargin"><code class="language-csharp">
// !!!! This is not recommended !!!!
//to save
byte[] bytes = BGRepo.I.Save();

//to load
BGRepo.I.Load(bytes);
</code></pre>
<p>
    The above call does not support <a href="../Partition">Partition</a> and <a href="../../../BGLocalization">localization</a> addons currently
</p>

<h4 id="mergesettings">Using Merge settings</h4>
<p>
    Using Merge settings you can choose which data to save/load.
    You want as less data to be saved as possible.
    You do not need to include data, which is "static" and can not be changed during play session.
</p>

<p>
    There are only 2 rules for using merge settings and condition for choosing one or another is whether or not rows can be added or removed at runtime.
</p>
<table class="contentTable">
    <tr>
        <th></th>
        <th>
            Rule #1
        </th>
        <th>
            Rule #2
        </th>
    </tr>
    <tr>
        <th>
            Condition
        </th>
        <td>Rows can NOT be added/deleted at runtime</td>
        <td>Rows can be added/deleted at runtime</td>
    </tr>
    <tr>
        <th>
            How to apply
        </th>
        <td>
            Turn on "Update matching".
            Optionally turn "Chose fields to update" on and mark the fields you want to be saved.
            (Tip: do not mark the fields which can not be changed at runtime)
        </td>
        <td>Turn on "Add missing", "Remove Orphaned", "Update matching".</td>
    </tr>
    <tr>
        <th rowspan="2">
            Example
        </th>
        <td colspan="2" style="text-align: center;font-size: 12px;">We use our <a href="../../Downloads/Example3DBasic">Basic 3D project</a> as an example</td>
    </tr>
    <tr>
        <td>
            Rows from <code>Player</code> table can not be added or removed, so we do not turn on "Add missing" and "Remove Orphaned".
            There is no need to save a <code>name</code> field, so we do not include it into settings
        </td>
        <td>
            Rows from <code>Collectable</code> table can be added and removed, so we turn on "Add missing", "Remove Orphaned", "Update matching"
        </td>
    </tr>
    <tr>
        <th>
            Screenshot for example
        </th>
        <td>
            <div class="bg-image">
                <a href="#path images/BGDatabase/SaveLoad1.png"><img style="max-width: 200px"
                                                                     src="#path images/BGDatabase/SaveLoad1.png"></a>
            </div>
        </td>
        <td>
            <div class="bg-image">
                <a href="#path images/BGDatabase/SaveLoad2.png"><img style="max-width: 200px"
                                                                     src="#path images/BGDatabase/SaveLoad2.png"></a>
            </div>
        </td>
    </tr>
</table>
<div class="flexdiv">
    <div>
        Read more about:
        <ol>
            <li><a href="../../ExportImport#mergeSettings">Merge settings</a></li>
            <li><a href="../../Downloads/Example3DBasic">Basic 3D example project</a></li>
        </ol>
    </div>
</div>


<h4 id="compatible">How to change your database and keep it compatible with old save files?</h4>
<ol>
    <li>Do not include static data (the data, which can not be changed during game session) to save/load merge settings</li>
    <li>While developing new, public version of your game- you can change <i>anything</i> in your static data with one simple exception:
        you can not delete rows which may be referenced from saved data.
        Well, actually you can, but in this case you need to make sure your code should handle null relation values properly.(and they will be null if you remove the rows)
    </li>
    <li>As for the data, which is saved within database snapshot (save file),
        <ul>
            <li>
                if you mark the field for saving using <a href="#mergesettings">merge settings</a> ("Update Matching") it will be loaded if the target row still exists in the default database
            </li>
            <li>
                if you mark the rows for saving ("Add missing" and "Remove Orphaned") the whole table will be updated with values from the saved file during loading, if this table (meta) still exists
                in the default database.
            </li>
            <li>
                if you want fine-grained, row-level control over loading - you can do it with C# controller class (read the <a href="#rowlevelexample">next section</a> for more details).
            </li>
        </ul>

    </li>
</ol>
<p>
    Here is an example from our <a href="../../Downloads/Example3DBasic">basic 3D example</a> project:
</p>
<div class="bg-image">
    <a href="#path images/BGDatabase/SaveLoadAddon2.png"><img style="width: 400px"
                                                              src="#path images/BGDatabase/SaveLoadAddon2.png"></a>
</div>


<h4 id="rowlevelexample">Row-level control over loading</h4>
<p>
    Merge settings give you control over which tables/fields you want to save. But what about particular rows?
    What if you want to update/add/delete only those rows which comply to some condition?
</p>
<p>
    This can be done with C# controller class, which can cancel update operation before it actually takes place.
    Currently there is no any merging on saving data, only on loading (but we reserved "merging on saving" option for future releases)
</p>
<p>
    Here is a quick example of custom controller class.
    This controller is made for our <a href="../../Downloads/Example3DBasic">basic 3D example</a> project.
</p>
<p>
    The main objective of this example controller is to prevent deleting Collectable rows for added scenes (scenes which was added between public game releases)
</p>
<details>
    <summary>Here is the code</summary>
    <pre class="nomargin"><code class="language-csharp">using BansheeGz.BGDatabase;

    // Warning!!! this controller is implemented without code generation
    //and may contains ugly boilerplate code
 public class MyCustomSaveLoadController : BGMergeSettingsEntity.IMergeReceiver,BGMergeSettingsEntity.IRemoveOrphanedReceiver
 {
     private bool loading;

     public bool OnBeforeMerge(BGRepo from, BGRepo to)
     {
         //here we want to know, if it's loading or saving?
         //... Note (currently there is no merging on saving, but it can be implemented in future releases)
         loading = to == BGRepo.I;
         return false;
     }

     public void OnAfterMerge(BGRepo from, BGRepo to)
     {
         //no need to write anything here
     }

     //this callback is invoked before row removal. Return true to cancel this operation
     public bool OnBeforeDelete(BGEntity toEntity)
     {
         if (loading)
         {
             if ("Collectable".Equals(toEntity.Meta.Name))
             {
                 //before deleting Collectable row, we want to make sure- it's not connected to newly added scene
                 var scene = toEntity.Get&lt;BGEntity&gt;("Scene");
                 //if scene's version more than 0 - cancel removing by returning true
                 return scene != null && scene.Get&lt;int&gt;("version") > 0;
             }
         }

         return false;
     }
 }</code></pre>
</details>


<p>
    To see this controller in action:
</p>
<ul>
    <li>Download default 3D example project <a href="../../Downloads/Example3DBasic">here</a></li>
    <li>Run the scene (Assets\BGDatabaseBasic3DExample\Scenes\BGExample1.unity), collect some objects and save the game</li>
    <li>
        Let's assume this was made by a real player with our game version 1, and now we want to develop version 1.1 and we want to add a new scene.
        We could add a new scene without any controller and without any issue, but we want to populate this scene with Collectable rows,
        and we do not want them to be deleted while loading save file.
        Without this controller, all Collectable rows will be overriden with the data from the save file,
        cause in SaveLoad merge settings we marked this table for "addingMissing" and "removingOrphaned" (which basically mean the whole table will be restored from save file)
    </li>
    <li>At this point we start to develop game version 1.1. We will omit real scene creating, cause all we want- is to make sure our save file will be loaded properly
        and it will not erase our newly added collectables for new scene
    </li>
    <li>Open BGDatabase window, choose <code>Configuration->Scene</code> and add new int field, call it "version"</li>
    <li>Then choose <code>Database->Scene</code> and add a new scene</li>
    <li>For newly created scene assign "version" field to 1</li>
    <li>Choose "Collectable" field for new scene and add some Collectables</li>
    <li>Now choose <code>Addons->SaveLoad</code>, and assign "Controller Type" field to MyCustomSaveLoadController (this is a class name of our controller)</li>
    <li>Save the database and run BGExample1.unity scene again</li>
    <li>Load the game, choose <code>Database->Scene</code> and make sure all saved Collectables remain intact, just like newly added Collectables for our new scene.
        Also, you can run the same example without controller assigned to see the difference
    </li>
</ul>
<div class="flexdiv">
    <div>
        Read more about:
        <ol>
            <li>row-level controller on <a href="../../ExportImport#rowlevel">export/import page</a></li>
        </ol>
    </div>
</div>

<h4 id="rowlevelonSave">Row-level control on saving</h4>
<p>
    To filter out rows while saving the data, your C# controller should implement ISaveLoadAddonSavedEntityFilter interface.
    Method <code>bool OnSaveEntity(BGEntity entity);</code> will be called for every row and it should return true if you want to skip provided row.
</p>


<h4>BeforeSave event</h4>
You can declare you MonoBehavior script to be a receiver of BeforeSave event, so it could update the database before saving (code from the example project)
<pre class="nomargin"><code class="language-csharp">//this class implement BGAddonSaveLoad.BeforeSaveReciever interface,
//so OnBeforeSave method will be called before saving
public class BGPlayer : BGM_Player, BGAddonSaveLoad.BeforeSaveReciever
{
    ...
    //this method is called before saving
    void BGAddonSaveLoad.BeforeSaveReciever.OnBeforeSave()
    {
        //save current position , rotation and scene to the database
        m_position = transform.position;
        m_rotation = transform.rotation;
        m_scene = BGE_Scene.FindEntity(scene => string.Equals(scene.Name, SceneManager.GetActiveScene().name));
    }
}</code></pre>
Note, callback method is called on all loaded objects, including inactive game objects and prefabs.
Use the following code (at the beginning of your callback function) to filter out inactive game objects and prefabs.
<pre class="nomargin"><code class="language-csharp">        // use the following line to filter out components, attached to inactive GameObjects
        if (!gameObject.activeInHierarchy) return;

        // use the following line to filter out prefabs
        if (!gameObject.scene.IsValid()) return;</code></pre>

<h4 id="additionalConfigs">Additional configs</h4>
<p>
    Starting with BGDatabase version 1.8.0, additional optional configs can be created for SaveLoad addon to save/load different data, for example game settings.
    Here is how to use it:
</p>
<ol>
    <li>Create an additional config with name <code>Settings</code> and include game settings to this config
        <div class="bg-image">
            <a href="#path images/BGDatabase/SaveLoadAddon6.png"><img style="width: 400px"
                                                                      src="#path images/BGDatabase/SaveLoadAddon6.png"></a>
        </div>
    </li>
    <li>To save current settings data use this code
<pre class="nomargin"><code class="language-csharp">    var settingsSave = BGRepo.I.Addons.Get&lt;BGAddonSaveLoad&gt;().Save(new BGSaveLoadAddonSaveContext("Settings"));</code></pre>
    </li>
    <li>To load game settings on your application startup, use this code
<pre class="nomargin"><code class="language-csharp">    GRepo.I.Addons.Get&lt;BGAddonSaveLoad&gt;().Load(new BGSaveLoadAddonLoadContext(new BGSaveLoadAddonLoadContext.LoadRequest("Settings", settingsData)){ReloadDatabase = false});</code></pre>
    </li>
    <li>To load saved game using default config, use the following code. Preserve request is required to not lost settings data during main database reloading.
<pre class="nomargin"><code class="language-csharp">            BGRepo.I.Addons.Get&lt;BGAddonSaveLoad&gt;().Load(
            new BGSaveLoadAddonLoadContext(new BGSaveLoadAddonLoadContext.LoadRequest(BGAddonSaveLoad.DefaultSettingsName, gameSessionData))
            {
                //the data for "Settings" config will be saved before database is reloaded and loaded after database reloading
                PreserveRequests = new List&lt;BGSaveLoadAddonLoadContext.PreserveRequest&gt; { new BGSaveLoadAddonLoadContext.PreserveRequest("Settings") }
            }
        );</code></pre>
    </li>

</ol>

<div>
    <h4>Additional downloads</h4>
    <ol>
        <li><a href="../../Downloads/RuntimeSaveLoadPlaymaker">Custom actions</a> for Playmaker to support SaveLoad addon</li>
        <li><a href="../../Downloads/RuntimeSaveLoadBolt">Custom units</a> for Bolt to support SaveLoad addon</li>
        <li><a href="../../Downloads/RuntimeSaveLoadFlowCanvas">Custom nodes</a> for Flow Canvas</li>
        <li>Node Canvas <a href="../../Downloads/NodeCanvas">integration package</a> has custom actions to use with SaveLoad addon</li>
        <li>Behavior Designer <a href="../../Downloads/BehaviorDesigner">integration package</a> has custom actions to use with SaveLoad addon</li>
        <li>UNode <a href="../../Downloads/UNode">integration package</a> has custom nodes to use with SaveLoad addon</li>
        <li>Game Creator <a href="../../Downloads/GameCreator">integration package</a> has custom actions to use with SaveLoad addon</li>
    </ol>
</div>